{"ast":null,"code":"'use strict';\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.diffEpochValidators = exports.findSeatPrice = void 0;\n\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\n\nconst depd_1 = __importDefault(require(\"depd\"));\n/** Finds seat price given validators stakes and number of seats.\n *  Calculation follow the spec: https://nomicon.io/Economics/README.html#validator-selection\n * @params validators: current or next epoch validators.\n * @params maxNumberOfSeats: maximum number of seats in the network.\n * @params minimumStakeRatio: minimum stake ratio\n * @params protocolVersion: version of the protocol from genesis config\n */\n\n\nfunction findSeatPrice(validators, maxNumberOfSeats, minimumStakeRatio, protocolVersion) {\n  if (protocolVersion && protocolVersion < 49) {\n    return findSeatPriceForProtocolBefore49(validators, maxNumberOfSeats);\n  }\n\n  if (!minimumStakeRatio) {\n    const deprecate = depd_1.default('findSeatPrice(validators, maxNumberOfSeats)');\n    deprecate('`use `findSeatPrice(validators, maxNumberOfSeats, minimumStakeRatio)` instead');\n    minimumStakeRatio = [1, 6250]; // harcoded minimumStakeRation from 12/7/21\n  }\n\n  return findSeatPriceForProtocolAfter49(validators, maxNumberOfSeats, minimumStakeRatio);\n}\n\nexports.findSeatPrice = findSeatPrice;\n\nfunction findSeatPriceForProtocolBefore49(validators, numSeats) {\n  const stakes = validators.map(v => new bn_js_1.default(v.stake, 10)).sort((a, b) => a.cmp(b));\n  const num = new bn_js_1.default(numSeats);\n  const stakesSum = stakes.reduce((a, b) => a.add(b));\n\n  if (stakesSum.lt(num)) {\n    throw new Error('Stakes are below seats');\n  } // assert stakesSum >= numSeats\n\n\n  let left = new bn_js_1.default(1),\n      right = stakesSum.add(new bn_js_1.default(1));\n\n  while (!left.eq(right.sub(new bn_js_1.default(1)))) {\n    const mid = left.add(right).div(new bn_js_1.default(2));\n    let found = false;\n    let currentSum = new bn_js_1.default(0);\n\n    for (let i = 0; i < stakes.length; ++i) {\n      currentSum = currentSum.add(stakes[i].div(mid));\n\n      if (currentSum.gte(num)) {\n        left = mid;\n        found = true;\n        break;\n      }\n    }\n\n    if (!found) {\n      right = mid;\n    }\n  }\n\n  return left;\n} // nearcore reference: https://github.com/near/nearcore/blob/5a8ae263ec07930cd34d0dcf5bcee250c67c02aa/chain/epoch_manager/src/validator_selection.rs#L308;L315\n\n\nfunction findSeatPriceForProtocolAfter49(validators, maxNumberOfSeats, minimumStakeRatio) {\n  if (minimumStakeRatio.length != 2) {\n    throw Error('minimumStakeRatio should have 2 elements');\n  }\n\n  const stakes = validators.map(v => new bn_js_1.default(v.stake, 10)).sort((a, b) => a.cmp(b));\n  const stakesSum = stakes.reduce((a, b) => a.add(b));\n\n  if (validators.length < maxNumberOfSeats) {\n    return stakesSum.mul(new bn_js_1.default(minimumStakeRatio[0])).div(new bn_js_1.default(minimumStakeRatio[1]));\n  } else {\n    return stakes[0].add(new bn_js_1.default(1));\n  }\n}\n/** Diff validators between current and next epoch.\n * Returns additions, subtractions and changes to validator set.\n * @params currentValidators: list of current validators.\n * @params nextValidators: list of next validators.\n */\n\n\nfunction diffEpochValidators(currentValidators, nextValidators) {\n  const validatorsMap = new Map();\n  currentValidators.forEach(v => validatorsMap.set(v.account_id, v));\n  const nextValidatorsSet = new Set(nextValidators.map(v => v.account_id));\n  return {\n    newValidators: nextValidators.filter(v => !validatorsMap.has(v.account_id)),\n    removedValidators: currentValidators.filter(v => !nextValidatorsSet.has(v.account_id)),\n    changedValidators: nextValidators.filter(v => validatorsMap.has(v.account_id) && validatorsMap.get(v.account_id).stake != v.stake).map(v => ({\n      current: validatorsMap.get(v.account_id),\n      next: v\n    }))\n  };\n}\n\nexports.diffEpochValidators = diffEpochValidators;","map":{"version":3,"names":["__importDefault","mod","__esModule","Object","defineProperty","exports","value","diffEpochValidators","findSeatPrice","bn_js_1","require","depd_1","validators","maxNumberOfSeats","minimumStakeRatio","protocolVersion","findSeatPriceForProtocolBefore49","deprecate","default","findSeatPriceForProtocolAfter49","numSeats","stakes","map","v","stake","sort","a","b","cmp","num","stakesSum","reduce","add","lt","Error","left","right","eq","sub","mid","div","found","currentSum","i","length","gte","mul","currentValidators","nextValidators","validatorsMap","Map","forEach","set","account_id","nextValidatorsSet","Set","newValidators","filter","has","removedValidators","changedValidators","get","current","next"],"sources":["C:/Projects/near-marketplace-dapp/near-marketplace/node_modules/near-api-js/lib/validators.js"],"sourcesContent":["'use strict';\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.diffEpochValidators = exports.findSeatPrice = void 0;\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\nconst depd_1 = __importDefault(require(\"depd\"));\n/** Finds seat price given validators stakes and number of seats.\n *  Calculation follow the spec: https://nomicon.io/Economics/README.html#validator-selection\n * @params validators: current or next epoch validators.\n * @params maxNumberOfSeats: maximum number of seats in the network.\n * @params minimumStakeRatio: minimum stake ratio\n * @params protocolVersion: version of the protocol from genesis config\n */\nfunction findSeatPrice(validators, maxNumberOfSeats, minimumStakeRatio, protocolVersion) {\n    if (protocolVersion && protocolVersion < 49) {\n        return findSeatPriceForProtocolBefore49(validators, maxNumberOfSeats);\n    }\n    if (!minimumStakeRatio) {\n        const deprecate = depd_1.default('findSeatPrice(validators, maxNumberOfSeats)');\n        deprecate('`use `findSeatPrice(validators, maxNumberOfSeats, minimumStakeRatio)` instead');\n        minimumStakeRatio = [1, 6250]; // harcoded minimumStakeRation from 12/7/21\n    }\n    return findSeatPriceForProtocolAfter49(validators, maxNumberOfSeats, minimumStakeRatio);\n}\nexports.findSeatPrice = findSeatPrice;\nfunction findSeatPriceForProtocolBefore49(validators, numSeats) {\n    const stakes = validators.map(v => new bn_js_1.default(v.stake, 10)).sort((a, b) => a.cmp(b));\n    const num = new bn_js_1.default(numSeats);\n    const stakesSum = stakes.reduce((a, b) => a.add(b));\n    if (stakesSum.lt(num)) {\n        throw new Error('Stakes are below seats');\n    }\n    // assert stakesSum >= numSeats\n    let left = new bn_js_1.default(1), right = stakesSum.add(new bn_js_1.default(1));\n    while (!left.eq(right.sub(new bn_js_1.default(1)))) {\n        const mid = left.add(right).div(new bn_js_1.default(2));\n        let found = false;\n        let currentSum = new bn_js_1.default(0);\n        for (let i = 0; i < stakes.length; ++i) {\n            currentSum = currentSum.add(stakes[i].div(mid));\n            if (currentSum.gte(num)) {\n                left = mid;\n                found = true;\n                break;\n            }\n        }\n        if (!found) {\n            right = mid;\n        }\n    }\n    return left;\n}\n// nearcore reference: https://github.com/near/nearcore/blob/5a8ae263ec07930cd34d0dcf5bcee250c67c02aa/chain/epoch_manager/src/validator_selection.rs#L308;L315\nfunction findSeatPriceForProtocolAfter49(validators, maxNumberOfSeats, minimumStakeRatio) {\n    if (minimumStakeRatio.length != 2) {\n        throw Error('minimumStakeRatio should have 2 elements');\n    }\n    const stakes = validators.map(v => new bn_js_1.default(v.stake, 10)).sort((a, b) => a.cmp(b));\n    const stakesSum = stakes.reduce((a, b) => a.add(b));\n    if (validators.length < maxNumberOfSeats) {\n        return stakesSum.mul(new bn_js_1.default(minimumStakeRatio[0])).div(new bn_js_1.default(minimumStakeRatio[1]));\n    }\n    else {\n        return stakes[0].add(new bn_js_1.default(1));\n    }\n}\n/** Diff validators between current and next epoch.\n * Returns additions, subtractions and changes to validator set.\n * @params currentValidators: list of current validators.\n * @params nextValidators: list of next validators.\n */\nfunction diffEpochValidators(currentValidators, nextValidators) {\n    const validatorsMap = new Map();\n    currentValidators.forEach(v => validatorsMap.set(v.account_id, v));\n    const nextValidatorsSet = new Set(nextValidators.map(v => v.account_id));\n    return {\n        newValidators: nextValidators.filter(v => !validatorsMap.has(v.account_id)),\n        removedValidators: currentValidators.filter(v => !nextValidatorsSet.has(v.account_id)),\n        changedValidators: nextValidators.filter(v => (validatorsMap.has(v.account_id) && validatorsMap.get(v.account_id).stake != v.stake))\n            .map(v => ({ current: validatorsMap.get(v.account_id), next: v }))\n    };\n}\nexports.diffEpochValidators = diffEpochValidators;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}